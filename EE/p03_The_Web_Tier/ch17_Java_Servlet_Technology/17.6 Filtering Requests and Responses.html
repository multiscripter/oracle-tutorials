<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>17.6. Запросы и ответы на фильтрацию</title>
</head>
<body>
    <h1>17.6. Запросы и ответы на фильтрацию</h1>
    <p>
        <b>Фильтр</b>&nbsp;&mdash; это объект, который может преобразовывать заголовок и&nbsp;контент (или оба)
        запроса или ответа. Фильтры отличаются от&nbsp;веб-компонентов тем, что фильтры сами по&nbsp;себе
        не&nbsp;создают ответ. Вместо этого фильтр предоставляет функциональные возможности, которые могут быть
        &laquo;привязаны&raquo; к&nbsp;любому веб-ресурсу. Следовательно, фильтр не&nbsp;должен иметь никаких
        зависимостей от&nbsp;веб-ресурса, для которого он&nbsp;действует как фильтр; таким образом, он&nbsp;может
        быть составлен с&nbsp;несколькими типами веб-ресурсов.
    </p>
    <p>Основные задачи, которые может выполнять фильтр, заключаются в&nbsp;следующем:</p>
    <ul>
        <li>
            <p>
                Запросить запрос (request) и&nbsp;действовать соответствующим образом.
            </p>
        </li>
        <li>
            <p>
                Заблокировать пару запроса и&nbsp;ответа от&nbsp;дальнейшего прохождения.
            </p>
        </li>
        <li>
            <p>
                Изменить заголовки и&nbsp;данные запроса. Вы&nbsp;делаете это, предоставляя индивидуальную
                версию запроса.
            </p>
        </li>
        <li>
            <p>
                Изменить заголовки ответов и&nbsp;данные. Вы&nbsp;делаете это, предоставляя индивидуальную
                версию ответа.
            </p>
        </li>
        <li>
            <p>
                Взаимодействовать с&nbsp;внешними ресурсами.
            </p>
        </li>
    </ul>
    <p>
        Приложения фильтров включают аутентификацию, протоколирование, преобразование изображений, сжатие данных,
        шифрование, токенизацию потоков, преобразование XML и&nbsp;т.д.
    </p>
    <p>
        Вы&nbsp;можете настроить веб-ресурс, который будет фильтроваться цепочкой из&nbsp;нуля, одного
        или нескольких фильтров в&nbsp;определенном порядке. Эта цепочка указывается, когда веб-приложение,
        содержащее компонент, развертывается и&nbsp;создается его экземпляр во время загрузки веб-контейнером
        компонента.
    </p>
    <h2>17.6.1 Программирование фильтров</h2>
    <p>
        API фильтрации определяется фильтрами <code>Filter, FilterChain</code> и&nbsp;<code>FilterConfig</code>
        в&nbsp;пакете <code>javax.servlet</code>.
        Вы&nbsp;определяете фильтр, реализуя интерфейс <code>Filter</code>.
    </p>
    <p>
        Используйте аннотацию <code>@WebFilter</code>, чтобы определить фильтр в&nbsp;веб-приложении.
        Эта аннотация указывается в&nbsp;классе и&nbsp;содержит метаданные об&nbsp;объявлении фильтра.
        Аннотированный фильтр должен указывать хотя&nbsp;бы один шаблон URL. Это делается с&nbsp;помощью атрибута
        <code>urlPatterns</code> или <code>value</code> в&nbsp;аннотации. Все остальные атрибуты являются
        необязательными, с&nbsp;настройками по&nbsp;умолчанию. Используйте атрибут <code>value</code>,
        когда единственным атрибутом аннотации является шаблон URL; используйте атрибут <code>urlPatterns</code>,
        когда используются другие атрибуты.
    </p>
    <p>
        Классы, аннотированные аннотацией <code>@WebFilter</code>, должны реализовывать интерфейс
        <code>javax.servlet.Filter</code>.
    </p>
    <p>
        Чтобы добавить данные конфигурации в&nbsp;фильтр, укажите атрибут <code>initParams</code> аннотации
        <code>@WebFilter</code>. Атрибут <code>initParams</code> содержит аннотацию <code>@WebInitParam</code>.
        Следующий фрагмент кода определяет фильтр с параметрами инициализации:
    </p>
    <pre>import javax.servlet.Filter;
import javax.servlet.annotation.WebFilter;
import javax.servlet.annotation.WebInitParam;
@WebFilter(filterName = "TimeOfDayFilter",
urlPatterns = {"/*"},
initParams = {
    @WebInitParam(name = "mood", value = "awake")})
public class TimeOfDayFilter implements Filter {
    ...
    </pre>
    <p>
        Наиболее важным методом в&nbsp;интерфейсе фильтра является <code>doFilter</code>, который передает
        объекты запроса, ответа и&nbsp;фильтрации. Этот метод может выполнять следующие действия.
    </p>
    <ul>
        <li>
            <p>
                Просмотреть заголовки запросов.
            </p>
        </li>
        <li>
            <p>
                Настроить объект запроса, если фильтр хочет изменить заголовки запроса или данные.
            </p>
        </li>
        <li>
            <p>
                Настроить объект ответа, если фильтр хочет изменить заголовки ответов или данные.
            </p>
        </li>
        <li>
            <p>
                Вызвать следующий объект в&nbsp;цепочке фильтров. Если текущий фильтр является последним фильтром
                в&nbsp;цепочке, который заканчивается целевым веб-компонентом или статическим ресурсом, следующим
                объектом является ресурс в&nbsp;конце цепочки; в&nbsp;противном случае это следующий фильтр,
                который был настроен в&nbsp;WAR. Фильтр вызывает следующий объект, вызывая метод
                <code>doFilter</code> в&nbsp;объекте цепочки, передавая запрос и&nbsp;ответ, с&nbsp;которым
                он&nbsp;был вызван, или завершенные версии, которые он&nbsp;мог создать. В&nbsp;качестве
                альтернативы фильтр может выбрать блокировку запроса, не&nbsp;делая вызов для вызова следующего
                объекта. В&nbsp;последнем случае фильтр отвечает за&nbsp;заполнение ответа.
            </p>
        </li>
        <li>
            <p>
                Просмотреть заголовки ответов после вызова следующего фильтра в&nbsp;цепочке.
            </p>
        </li>
        <li>
            <p>
                Выбросить исключение, чтобы указать на&nbsp;ошибку при обработке.
            </p>
        </li>
    </ul>
    <p>
        В&nbsp;дополнение к&nbsp;<code>doFilter</code> вы&nbsp;должны реализовать методы <code>init</code>
        и&nbsp;<code>destroy</code>. Метод <code>init</code> вызывается контейнером при создании экземпляра
        фильтра. Если вы&nbsp;хотите передать параметры инициализации фильтру, вы&nbsp;извлекаете
        их&nbsp;из&nbsp;объекта <code>FilterConfig</code>, переданного в&nbsp;<code>init</code>.
    </p>
    <h2>17.6.2 Программирование индивидуальных запросов и&nbsp;ответов</h2>
    <p>
        Существует множество способов изменения фильтра для запроса или ответа. Например, фильтр может добавить
        атрибут к&nbsp;запросу или может вставить данные в&nbsp;ответ.
    </p>
    <p>
        Фильтр, который изменяет ответ, обычно должен захватывать ответ до&nbsp;его возврата клиенту.
        Для этого вы&nbsp;передаете резервный поток сервлету, который генерирует ответ.
        Резервный поток предотвращает закрытие исходного потока ответа сервлетом при его завершении
        и&nbsp;позволяет фильтру изменять ответ сервлета.
    </p>
    <p>
        Чтобы передать этот резервный поток сервлету, фильтр создает оболочку ответа, которая переопределяет
        метод <code>getWriter</code> или <code>getOutputStream</code>, чтобы вернуть этот поток в&nbsp;режиме
        ожидания. Обертка передается методу <code>doFilter</code> цепи фильтра. Методы-обёртки по&nbsp;умолчанию
        обращаются к&nbsp;обернутому объекту запроса или ответа.
    </p>
    <p>
        Чтобы переопределить методы запроса, вы&nbsp;переносите запрос в&nbsp;объект, который расширяет либо
        <code>ServletRequestWrapper</code>, либо <code>HttpServletRequestWrapper</code>. Чтобы переопределить
        методы ответа, вы&nbsp;завершаете ответ в&nbsp;объекте, который расширяет либо
        <code>ServletResponseWrapper</code>, либо <code>HttpServletResponseWrapper</code>.
    </p>
    <h2>17.6.3. Определение сопоставлений фильтров</h2>
    <p>
        Веб-контейнер использует сопоставления фильтров, чтобы решить, как применять фильтры к&nbsp;веб-ресурсам.
        Отображение фильтра соответствует фильтру веб-компонента по&nbsp;имени или веб-ресурсов по&nbsp;шаблону URL.
        Фильтры вызывают в&nbsp;том порядке, в&nbsp;котором встречаются в&nbsp;списке
        отображения фильтров в WAR. Вы&nbsp;указываете список сопоставлений фильтров для WAR в&nbsp;его дескрипторе
        развертывания либо с&nbsp;помощью среды NetBeans, либо с&nbsp;помощью XML-кода.
    </p>
    <p>
        Если вы&nbsp;хотите регистрировать каждый запрос в&nbsp;веб-приложении, вы&nbsp;сопоставляете фильтр
        счетчиков с&nbsp;шаблоном URL /*.
    </p>
    <p>
        Вы&nbsp;можете сопоставить фильтр с&nbsp;одним или несколькими веб-ресурсами, а&nbsp;можете
        сопоставить несколько фильтров с&nbsp;веб-ресурсом. Это проиллюстрировано на&nbsp;рисунке 17-1,
        в&nbsp;котором фильтр F1&nbsp;отображается на&nbsp;сервлеты S1, S2&nbsp;и&nbsp;S3; фильтр
        F2&nbsp;отображается на&nbsp;сервлет&nbsp;S2; и&nbsp;фильтр F3&nbsp;отображается на&nbsp;сервлеты
        S1&nbsp;и&nbsp;S2.
    </p>
    <p><i><b>Рисунок 17-1. Сопоставление фильтра с&nbsp;сервлетом</b></i></p>
    <img src="./images/jeett_dt_018.png" alt="" />
    <p>
        Напомним, что цепочка фильтров является одним из&nbsp;объектов, переданных методу <code>doFilter</code>
        фильтра. Эта цепочка формируется косвенно с&nbsp;помощью фильтрующих отображений. Порядок фильтров
        в&nbsp;цепочке совпадает с&nbsp;порядком отображения фильтров в&nbsp;дескрипторе развертывания
        веб-приложения.
    </p>
    <p>
        Когда фильтр отображается на&nbsp;сервлет&nbsp;S1, веб-контейнер вызывает метод doFilter для F1.
        Метод doFilter каждого фильтра в&nbsp;цепочке фильтров S1&nbsp;вызывается предыдущим фильтром
        в&nbsp;цепочке с&nbsp;помощью метода chain.doFilter. Поскольку цепочка фильтров S1&nbsp;содержит
        фильтры F1&nbsp;и&nbsp;F3, вызов F1&nbsp;для chain.doFilter вызывает метод doFilter фильтра F3.
        Когда метод doFilter F3&nbsp;завершается, управление возвращается к&nbsp;методу doFilter&nbsp;F1.
    </p>
    <h3>17.6.3.1 Определение сопоставлений фильтров с&nbsp;использованием среды IDE NetBeans</h3>
    <ol>
        <li>
            <p>Разверните узел проекта приложения на&nbsp;вкладке <b>Project</b> (Проект)</p>
        </li>
        <li>
            <p>Разверните узлы <b>Web Pages</b> (Веб-страницы) и&nbsp;<b>WEB-INF</b> под узлом проекта.</p>
        </li>
        <li>
            <p>Дважды нажмите <code>web.xml</code></p>
        </li>
        <li>
            <p>Нажмите <b>Filters</b> (Фильтры) в&nbsp;верхней части окна редактора.</p>
        </li>
        <li>
            <p>Разверните узел <b>Servlet Filters</b> (Фильтры сервлетов) в&nbsp;окне редактора.</p>
        </li>
        <li>
            <p>
                Нажмите <b>Add Filter Element</b> (Добавить элемент фильтра), чтобы отобразить фильтр
                на&nbsp;веб-ресурс по&nbsp;имени или по&nbsp;шаблону URL.
            </p>
        </li>
        <li>
            <p>
                В&nbsp;диалоговом окне добавления фильтра сервлета введите имя фильтра
                в&nbsp;поле <b>Filter Name</b> (Имя фильтра).
            </p>
        </li>
        <li>
            <p>
                Нажмите <b>Browse</b> (Обзор), чтобы найти класс сервлета, к&nbsp;которому применяется фильтр.
            </p>
            <p>
                Вы&nbsp;можете включать подстановочные знаки, чтобы вы&nbsp;могли применить фильтр
                к&nbsp;нескольким сервлетам.
            </p>
        </li>
        <li>
            <p>Нажмите <b>OK</b>.</p>
        </li>
        <li>
            <p>
                Чтобы ограничить использование фильтра для запросов, выполните следующие действия:
            </p>
            <ol>
                <li>
                    <p>Разверните узел <b>Filter Mappings</b> (Сопоставления фильтров).</p>
                </li>
                <li>
                    <p>Выберите фильтр из&nbsp;списка фильтров.</p>
                </li>
                <li>
                    <p>Нажмите <b>Add</b> (Добавить).</p>
                </li>
                <li>
                    <p>
                        В&nbsp;диалоговом окне добавления фильтра выберите один из&nbsp;следующих типов диспетчера:
                    </p>
                    <ul>
                        <li>
                            <p>
                                <b>REQUEST</b> (ЗАПРОС): только когда запрос поступает непосредственно
                                от&nbsp;клиента
                            </p>
                        </li>
                        <li>
                            <p>
                                <b>ASYNC</b> (АСИНХРОННЫЙ): только когда асинхронный запрос поступает
                                от&nbsp;клиента
                            </p>
                        </li>
                        <li>
                            <p>
                                <b>FORWARD</b> (ОТПРАВИТЬ): только когда запрос был отправлен компоненту
                                (см. &laquo;Перенос элемента управления в&nbsp;другой веб-компонент&raquo;)
                            </p>
                        </li>
                        <li>
                            <p>
                                <b>INCLUDE</b> (ВКЛЮЧИТЬ): Только когда запрос обрабатывается компонентом,
                                который был включен (см. &laquo;Включение других ресурсов в&nbsp;ответ&raquo;)
                            </p>
                        </li>
                        <li>
                            <p>
                                <b>ERROR</b> (ОШИБКА): Только когда запрос обрабатывается механизмом страницы ошибки
                                (см. &laquo;Обработка ошибок сервлета&raquo;)
                            </p>
                        </li>
                    </ul>
                    <p>
                        Вы&nbsp;можете определить фильтр, который будет применяться к&nbsp;любой комбинации
                        предыдущих ситуаций, выбрав несколько типов диспетчера. Если типы не&nbsp;указаны,
                        по&nbsp;умолчанию используется опция <b>REQUEST</b> (ЗАПРОС).
                    </p>
                </li>
            </ol>
        </li>
    </ol>
</body>
</html>